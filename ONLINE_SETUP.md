# Spire Online Setup (Free-Tier Friendly)

This guide moves the app from local-only storage to online auth + campaign sharing with GM invites.

## Architecture
- Auth: Supabase Auth (email/password)
- DB: Supabase Postgres
- Permissions: RLS + campaign memberships (`gm` / `player`)
- Session join: invite code generated by GM
- App hosting: Vercel (frontend)

## 1) Create Supabase Project
1. Create a Supabase project (free tier).
2. In SQL Editor, run [`supabase/schema.sql`](/Users/ernestomatos/Downloads/files%20(9)/supabase/schema.sql).
3. In Auth settings:
- Enable Email auth.
- Disable anonymous auth.
- Optionally disable email confirmation for faster testing.

## 2) Map Current Product Rules to DB
- GM account: profile `account_type='gm'`
- Player account: profile `account_type='player'`
- GM creates campaign using `rpc('create_campaign')`
- GM generates invite code using `rpc('generate_invite_code')`
- Player joins via `rpc('join_campaign_with_code')`
- Access is checked by membership role in RLS and helper `user_campaign_role`.

## 3) Frontend Integration Checklist
The app now supports Supabase cloud mode when configured.

1. Set credentials in [`config.js`](/Users/ernestomatos/Downloads/files%20(9)/config.js):
- `window.SPIRE_SUPABASE_URL`
- `window.SPIRE_SUPABASE_ANON_KEY`

2. App behavior in cloud mode:
- Auth uses Supabase (`signUp` / `signInWithPassword`).
- Campaign list loads from `campaign_members -> campaigns`.
- Campaign saves update `campaigns.data`.
- GM invite generation uses RPC `generate_invite_code`.
- Player join uses RPC `join_campaign_with_code`.
- Revoke invite updates `invite_codes.revoked=true`.

3. Local fallback:
- If Supabase config is missing, app falls back to local-only auth/storage.

## 4) Minimal API Calls
```js
const { data, error } = await supabase.auth.signUp({
  email,
  password,
  options: { data: { username, account_type: 'gm' } }
});

await supabase.rpc('create_campaign', { p_name: 'New Campaign' });
await supabase.rpc('generate_invite_code', {
  p_campaign_id: campaignId,
  p_role_to_grant: 'player',
  p_max_uses: 1,
  p_expires_minutes: 1440
});
await supabase.rpc('join_campaign_with_code', { p_code: code });
```

## 5) Free-Tier Notes
- Supabase free has limits (DB size, auth MAU, realtime quotas).
- Vercel free is fine for this frontend.
- Avoid storing huge history blobs in one JSON row forever; periodically archive logs.

## 6) Security Notes
- Never trust role checks from frontend only; rely on RLS.
- Keep invite codes expiring and revokable.
- Use HTTPS only.

## 7) Migration Strategy from Local Data
- Add an "Upload local campaign to cloud" button for GM.
- First sync: write local campaign object to `campaigns.data`.
- Afterwards: cloud is source of truth.

## 8) Deploy (Online)
1. Push this folder to GitHub.
2. Import the repo into Vercel (Framework preset: `Other` / static site).
3. Set build command empty; output directory `.`.
4. Add a `config.js` in deployed root with your Supabase URL/key values.
5. Open the deployed URL and register/login.
