<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Spire Campaign Manager</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=6">
</head>
<body>
  <div id="app">
    <!-- AUTH SCREEN -->
    <div id="auth-screen">
      <div class="mode-screen-bg"></div>
      <div class="auth-screen-content">
        <div class="mode-logo">
          <div class="mode-logo-icon">â¬¡</div>
          <h1>Spire</h1>
          <p>Sign in to continue</p>
        </div>
        <div class="auth-card">
          <div class="auth-tabs">
            <button id="auth-tab-login" class="auth-tab active">Login</button>
            <button id="auth-tab-register" class="auth-tab">Create User</button>
          </div>
          <div class="auth-fields">
            <label for="auth-username">Username</label>
            <input id="auth-username" type="text" autocomplete="username" />
            <label for="auth-password">Password</label>
            <input id="auth-password" type="password" autocomplete="current-password" />
            <div id="auth-confirm-wrap" class="hidden">
              <label for="auth-password-confirm">Confirm Password</label>
              <input id="auth-password-confirm" type="password" autocomplete="new-password" />
            </div>
          </div>
          <button id="auth-submit-btn" class="mode-btn mode-btn-gm auth-submit-btn">Login</button>
          <p id="auth-message" class="auth-message"></p>
        </div>
      </div>
    </div>

    <!-- MODE SELECTOR SCREEN -->
    <div id="mode-screen">
      <div class="mode-screen-bg"></div>
      <div class="mode-screen-content">
        <div class="mode-logo">
          <div class="mode-logo-icon">â¬¡</div>
          <h1>Spire</h1>
          <p>Campaign Manager</p>
        </div>
        <div class="mode-user-row">
          <span id="mode-current-user"></span>
          <button id="mode-logout-user" class="toolbar-btn toolbar-btn-danger">
            <span class="material-icons">logout</span> Logout
          </button>
        </div>
        <div class="mode-campaign-selector">
          <label>Campaign</label>
          <div class="mode-campaign-row">
            <select id="mode-campaign-select"></select>
            <button id="mode-new-campaign" title="New Campaign"><span class="material-icons">add</span></button>
            <button id="mode-join-code" title="Join via Invite Code"><span class="material-icons">group_add</span></button>
            <button id="mode-import-btn" title="Import Campaign"><span class="material-icons">file_download</span></button>
            <button id="mode-delete-campaign" title="Delete Campaign" class="mode-delete-btn"><span class="material-icons">delete</span></button>
            <input type="file" id="mode-import-input" accept="application/json" style="display:none">
          </div>
        </div>
        <div class="mode-buttons">
          <button class="mode-btn mode-btn-gm" id="enter-gm">
            <span class="mode-btn-icon"><span class="material-icons">shield</span></span>
            <span class="mode-btn-label">Game Master</span>
            <span class="mode-btn-desc">Full access. Manage secrets, NPCs &amp; the conspiracy web.</span>
          </button>
          <button class="mode-btn mode-btn-player" id="enter-player">
            <span class="mode-btn-icon"><span class="material-icons">person</span></span>
            <span class="mode-btn-label">Player</span>
            <span class="mode-btn-desc">View your character sheet and known connections.</span>
          </button>
        </div>
        <div class="mode-footer">
          <span id="mode-storage-note">Data saved locally in your browser</span>
        </div>
      </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="main-app" class="hidden">
      <!-- Top navigation bar -->
      <header id="top-nav">
        <div class="nav-left">
          <button id="back-to-mode" class="nav-icon-btn" title="Back to mode selection" aria-label="Back to mode selection">
            <span class="material-icons">arrow_back</span>
          </button>
          <div class="nav-brand">
            <span class="nav-brand-icon">â¬¡</span>
            <span id="campaign-name" class="nav-title">Untitled Campaign</span>
          </div>
          <div id="mode-badge" class="mode-badge mode-badge-gm">GM</div>
          <div id="pending-badge" class="pending-count-badge hidden" title="Pending NPC approvals"></div>
        </div>
        <div class="nav-middle">
          <button class="tab-link active" data-tab="sheets-view">
            <span class="material-icons tab-icon">description</span>
            <span class="tab-label">Sheets</span>
          </button>
          <button class="tab-link" data-tab="web-view">
            <span class="material-icons tab-icon">hub</span>
            <span class="tab-label">Web</span>
          </button>
          <button class="tab-link" data-tab="log-view">
            <span class="material-icons tab-icon">history</span>
            <span class="tab-label">Log</span>
          </button>
          <button class="tab-link" data-tab="messages-view">
            <span class="material-icons tab-icon">forum</span>
            <span class="tab-label">Messages</span>
            <span id="messages-unread-badge" class="tab-unread-badge hidden">0</span>
          </button>
          <button class="tab-link gm-only-tab" data-tab="gm-notes-view">
            <span class="material-icons tab-icon">sticky_note_2</span>
            <span class="tab-label">GM Notes</span>
          </button>
        </div>
        <div class="nav-right">
          <span id="save-state-indicator" class="save-state-indicator" aria-live="polite">Saved</span>
          <span id="sync-conflict-indicator" class="save-state-indicator state-error hidden" aria-live="polite">Updated in another tab</span>
          <button id="save-retry-btn" class="nav-icon-btn hidden" title="Retry save" aria-label="Retry save"><span class="material-icons">refresh</span></button>
          <button id="sync-reload-btn" class="nav-icon-btn hidden" title="Reload latest from another tab" aria-label="Reload latest campaign from another tab"><span class="material-icons">sync</span></button>
          <button id="sync-force-btn" class="nav-icon-btn hidden" title="Force overwrite with this tab" aria-label="Force overwrite with this tab"><span class="material-icons">warning</span></button>
          <button id="sync-queue-btn" class="nav-icon-btn" title="Sync queue (empty)" aria-label="Open sync queue">
            <span class="material-icons">cloud_sync</span>
            <span id="sync-queue-count" class="nav-icon-badge hidden">0</span>
          </button>
          <button id="undo-btn" class="nav-icon-btn" title="Undo last destructive action" aria-label="Undo last destructive action" disabled><span class="material-icons">undo</span></button>
          <button id="redo-btn" class="nav-icon-btn" title="Redo last undone action" aria-label="Redo last undone action" disabled><span class="material-icons">redo</span></button>
          <button id="save-btn" class="nav-icon-btn" title="Save (Ctrl+S)" aria-label="Save campaign"><span class="material-icons">save</span></button>
          <button id="shortcuts-btn" class="nav-icon-btn" title="Keyboard shortcuts (?)" aria-label="Keyboard shortcuts"><span class="material-icons">keyboard</span></button>
          <button id="dark-mode-btn" class="nav-icon-btn" title="Toggle dark mode" aria-label="Toggle dark mode"><span class="material-icons">dark_mode</span></button>
          <button id="export-btn" class="nav-icon-btn" title="Export" aria-label="Export campaign"><span class="material-icons">file_upload</span></button>
          <input type="file" id="import-input" accept="application/json" style="display:none">
          <button id="import-btn" class="nav-icon-btn" title="Import" aria-label="Import campaign"><span class="material-icons">file_download</span></button>
          <button id="dice-btn" class="nav-icon-btn" title="Dice roller" aria-label="Open dice roller"><span class="material-icons">casino</span></button>
          <button id="settings-btn" class="nav-icon-btn" title="Settings" aria-label="Open settings"><span class="material-icons">settings</span></button>
        </div>
      </header>

      <!-- Main layout -->
      <div id="layout">
        <!-- Sidebar -->
        <aside id="sidebar">
          <div class="sidebar-header">
            <div class="search-wrap">
              <span class="material-icons search-icon">search</span>
              <input type="text" id="search-input" placeholder="Search entitiesâ€¦" title="Search (/)"/>
            </div>
            <div class="sidebar-sort-row">
              <label for="entity-sort-select">Sort</label>
              <select id="entity-sort-select" title="Entity sort">
                <option value="manual">Manual</option>
                <option value="name">Name (A-Z)</option>
                <option value="pinned">Pinned first</option>
              </select>
            </div>
            <label class="sidebar-pin-only-row" for="entity-pin-only">
              <input type="checkbox" id="entity-pin-only" />
              <span>Pinned only</span>
            </label>
            <div id="gm-add-buttons" class="add-buttons">
              <button id="add-pc-btn" class="add-btn add-btn-pc" title="Add PC">
                <span class="material-icons">person_add</span>
                <span>PC</span>
              </button>
              <button id="add-npc-btn" class="add-btn add-btn-npc" title="Add NPC">
                <span class="material-icons">people</span>
                <span>NPC</span>
              </button>
              <button id="add-org-btn" class="add-btn add-btn-org" title="Add Organisation">
                <span class="material-icons">business</span>
                <span>Org</span>
              </button>
            </div>
            <div id="player-add-buttons" class="add-buttons">
              <button id="player-add-pc-btn" class="add-btn add-btn-pc" title="Create my character">
                <span class="material-icons">person_add</span>
                <span>My Character</span>
              </button>
              <button id="player-submit-npc-btn" class="add-btn add-btn-npc" title="Submit an NPC for GM approval">
                <span class="material-icons">person_add</span>
                <span>Submit NPC</span>
              </button>
            </div>
          </div>
          <div class="entity-lists">
            <details open>
              <summary>
                <span class="material-icons summary-icon">person</span>
                Player Characters
                <span id="pc-count" class="entity-count">0</span>
              </summary>
              <ul id="pc-list" class="entity-list"></ul>
            </details>
            <details open>
              <summary>
                <span class="material-icons summary-icon">people</span>
                NPCs
                <span id="npc-count" class="entity-count">0</span>
              </summary>
              <ul id="npc-list" class="entity-list"></ul>
            </details>
            <details open>
              <summary>
                <span class="material-icons summary-icon">business</span>
                Organisations
                <span id="org-count" class="entity-count">0</span>
              </summary>
              <ul id="org-list" class="entity-list"></ul>
            </details>
          </div>
        </aside>

        <!-- Main content area -->
        <main id="main-content">
          <!-- Sheets view -->
          <div id="sheets-view" class="tab-page active">
            <div id="sheet-placeholder" class="placeholder">
              <span class="material-icons placeholder-icon">description</span>
              <p>Select an entity from the sidebar to view its sheet. Use â†‘/â†“ to move between entities.</p>
            </div>
            <div id="sheet-container" class="sheet-container" style="display:none"></div>
          </div>

          <!-- Conspiracy web view -->
          <div id="web-view" class="tab-page">
            <div id="web-filter-bar" class="web-filter-bar">
              <span class="filter-label">Show:</span>
              <button type="button" class="filter-pill active" data-type="pc">PCs</button>
              <button type="button" class="filter-pill active" data-type="npc">NPCs</button>
              <button type="button" class="filter-pill active" data-type="org">Orgs</button>
              <button type="button" class="filter-pill active" data-type="secrets">ðŸ”’ Secrets</button>
              <span class="filter-sep"></span>
              <button type="button" class="filter-pill" id="filter-focus-toggle">Focus mode: Off</button>
            </div>
            <div id="web-legend">
              <span class="legend-item"><span class="legend-dot" style="background:var(--pc-color)"></span>PC</span>
              <span class="legend-item"><span class="legend-dot" style="background:var(--npc-color);border-radius:3px"></span>NPC</span>
              <span class="legend-item"><span class="legend-dot" style="background:var(--org-color);clip-path:polygon(50% 0%,93% 25%,93% 75%,50% 100%,7% 75%,7% 25%)"></span>Org</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#4caf50"></span>Ally</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#e53935"></span>Enemy</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#ff8f00"></span>Rival</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#e91e8c"></span>Romantic</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#8e44ad"></span>Family</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#0288d1"></span>Informant</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#01579b"></span>Handler</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#c62828"></span>Blackmail</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#b71c1c"></span>Targeting</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#546e7a"></span>Surveillance</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#6d4c41"></span>Patron/Client</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#5d4037"></span>Employer/Employee</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#558b2f"></span>Member Of</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#f57f17"></span>Owes / Debt</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#78909c"></span>Unknown/Unclear</span>
              <span class="legend-item"><span class="legend-swatch" style="background:#546e7a;border-top:2px dotted #546e7a;height:0"></span>Secret</span>
              <span class="legend-item"><span class="legend-swatch legend-swatch-solid"></span>Solid = standard</span>
              <span class="legend-item"><span class="legend-swatch legend-swatch-dashed"></span>Dashed = hostile/tense</span>
              <span class="legend-item"><span class="legend-swatch legend-swatch-dotted"></span>Dotted = covert/surveillance</span>
              <span class="legend-item"><span class="legend-swatch legend-swatch-fade"></span>Faded = de-emphasized/focus</span>
              <span id="legend-semantic-line" class="legend-semantic">Line width: default 2px, selected 3px. Directed links show arrowheads.</span>
              <span id="legend-semantic-visibility" class="legend-semantic">Visibility: GM-only nodes and secret links are hidden for players.</span>
              <span id="web-rel-hint" class="legend-semantic">Tip: add relationships to show edges between entities.</span>
              <span style="margin-left:auto;color:var(--spire-dim);font-size:0.65rem">Double-click node â†’ open sheet</span>
            </div>
            <div id="web-toolbar">
              <div class="web-toolbar-left">
                <button id="add-rel-btn" class="toolbar-btn" title="Add Relationship">
                  <span class="material-icons">link</span> Relationship
                </button>
                <button id="layout-btn" class="toolbar-btn" title="Auto layout">
                  <span class="material-icons">autorenew</span> Layout
                </button>
                <button id="export-png-btn" class="toolbar-btn" title="Export PNG">
                  <span class="material-icons">image</span> Export
                </button>
              </div>
              <div class="web-toolbar-right">
                <select id="graph-view-select" title="Saved graph view">
                  <option value="">View presetâ€¦</option>
                </select>
                <button id="save-graph-view-btn" class="toolbar-btn" title="Save current graph view">
                  <span class="material-icons">bookmark_add</span> Save View
                </button>
                <button id="delete-graph-view-btn" class="toolbar-btn toolbar-btn-danger" title="Delete selected graph view">
                  <span class="material-icons">bookmark_remove</span> Delete View
                </button>
                <select id="node-select" title="Jump to entity">
                  <option value="">Jump to entityâ€¦</option>
                </select>
              </div>
            </div>
            <div id="cy-container">
              <canvas id="graph-canvas"></canvas>
              <div id="graph-empty" class="graph-empty hidden">
                <span class="material-icons">hub</span>
                <p>Add entities and relationships to build your conspiracy web.</p>
              </div>
            </div>
          </div>

          <!-- Log view -->
          <div id="log-view" class="tab-page">
            <div id="log-toolbar">
              <div class="log-toolbar-left">
                <span class="log-title">Activity Log</span>
                <span id="log-session-badge" class="log-session-badge">Session 1</span>
              </div>
              <div class="log-toolbar-right">
                <input type="text" id="log-search-input" placeholder="Search logâ€¦" />
                <select id="log-session-filter" title="Filter by session">
                  <option value="all">All sessions</option>
                </select>
                <select id="log-actor-filter" title="Filter by actor">
                  <option value="all">All actors</option>
                </select>
                <select id="log-type-filter" title="Filter by action type">
                  <option value="all">All types</option>
                  <option value="action">Actions</option>
                  <option value="note">Notes</option>
                  <option value="session">Session markers</option>
                </select>
                <button id="generate-recap-btn" class="toolbar-btn" title="Generate session recap">
                  <span class="material-icons">summarize</span> Recap
                </button>
                <button id="new-session-btn" class="toolbar-btn" title="Start new session (resets core abilities)">
                  <span class="material-icons">play_circle</span> New Session
                </button>
                <button id="export-log-csv-btn" class="toolbar-btn" title="Export filtered log as CSV">
                  <span class="material-icons">download</span> CSV
                </button>
                <button id="clear-log-btn" class="toolbar-btn toolbar-btn-danger" title="Clear Log">
                  <span class="material-icons">delete</span> Clear
                </button>
              </div>
            </div>
            <div id="log-note-bar">
              <input type="text" id="log-note-input" placeholder="Add a session noteâ€¦" />
              <button id="log-note-btn" class="toolbar-btn"><span class="material-icons">add</span></button>
            </div>
            <div id="log-layout">
              <div id="session-prep-panel" class="session-prep-panel"></div>
              <ul id="log-list" class="log-list"></ul>
            </div>
            <div id="log-pagination" class="log-pagination hidden"></div>
            <div id="log-empty" class="log-empty hidden">
              <span class="material-icons">history</span>
              <p>No activity yet.</p>
            </div>
          </div>

          <!-- Messages view -->
          <div id="messages-view" class="tab-page">
            <div id="messages-toolbar">
              <div class="messages-title-wrap">
                <span class="log-title">Table Messages</span>
                <span id="messages-mode-badge" class="log-session-badge">Party</span>
              </div>
              <select id="messages-filter-select" title="Filter messages">
                <option value="all">All</option>
                <option value="unread">Unread</option>
                <option value="party">Party</option>
                <option value="whispers">Whispers</option>
              </select>
              <button id="mark-messages-read-btn" class="toolbar-btn" title="Mark all visible as read">
                <span class="material-icons">mark_email_read</span> Read
              </button>
              <button id="clear-messages-btn" class="toolbar-btn toolbar-btn-danger" title="Clear Messages">
                <span class="material-icons">delete</span> Clear
              </button>
            </div>
            <div id="messages-list" class="messages-list"></div>
            <div id="messages-compose" class="messages-compose">
              <select id="message-target-select" title="Message target"></select>
              <input type="text" id="message-input" placeholder="Write a messageâ€¦" />
              <button id="send-message-btn" class="toolbar-btn">
                <span class="material-icons">send</span>
              </button>
            </div>
          </div>

          <!-- GM Notes view -->
          <div id="gm-notes-view" class="tab-page">
            <div id="gm-notes-toolbar">
              <span class="log-title">GM Notes</span>
              <div class="gm-notes-toolbar-right">
                <button id="gm-add-session-note-btn" class="toolbar-btn" title="Add note to current session">
                  <span class="material-icons">note_add</span> Session Note
                </button>
                <button id="gm-add-global-note-btn" class="toolbar-btn" title="Add note outside sessions">
                  <span class="material-icons">push_pin</span> Outside Session
                </button>
              </div>
            </div>
            <div id="gm-notes-board" class="gm-notes-board"></div>
          </div>
        </main>

        <!-- Inspector panel -->
        <aside id="inspector" class="inspector hidden">
          <div class="inspector-header">
            <span class="inspector-title">Details</span>
            <button id="close-inspector" class="close-inspector" title="Close">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div id="inspector-content"></div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Hidden gm-toggle for JS compatibility -->
  <input type="checkbox" id="gm-toggle" style="display:none">

  <!-- Modal -->
  <div id="modal-overlay" class="hidden"></div>
  <div id="modal" class="modal hidden">
    <div class="modal-header">
      <span id="modal-title" class="modal-title"></span>
      <button id="close-modal" class="close-modal"><span class="material-icons">close</span></button>
    </div>
    <div id="modal-content"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js?v=1"></script>
  <script src="online-client.js?v=1"></script>
  <script src="rules-engine.js?v=1"></script>
  <script src="app.js?v=6"></script>
</body>
</html>
